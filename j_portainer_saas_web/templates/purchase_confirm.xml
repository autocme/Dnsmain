<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="purchase_confirm" name="Purchase Confirmation">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty">
                <div class="saas_purchase_confirm_page">
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-lg-8 col-md-10">
                                
                                <!-- Step Progress Bar -->
                                <div class="saas_steps_progress">
                                    <div class="saas_step saas_step_completed">
                                        <div class="saas_step_circle">
                                            <i class="fa fa-check"></i>
                                        </div>
                                        <div class="saas_step_content">
                                            <h6>Package Selection</h6>
                                            <p t-esc="package.pkg_name"/>
                                        </div>
                                    </div>
                                    
                                    <div class="saas_step_line saas_step_line_completed"></div>
                                    
                                    <div class="saas_step saas_step_current">
                                        <div class="saas_step_circle">
                                            <span>2</span>
                                        </div>
                                        <div class="saas_step_content">
                                            <h6 t-if="is_free_trial">Free Trial</h6>
                                            <h6 t-else="">Payment</h6>
                                            <p t-if="is_free_trial" t-esc="f'{free_trial_days} days free trial'"/>
                                            <p t-else="" t-esc="f'{currency_symbol}{price}/{period_text}'"/>
                                        </div>
                                    </div>
                                    
                                    <div class="saas_step_line"></div>
                                    
                                    <div class="saas_step">
                                        <div class="saas_step_circle">
                                            <span>3</span>
                                        </div>
                                        <div class="saas_step_content">
                                            <h6>Setup</h6>
                                            <p>Create your instance</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Package Details Card -->
                                <div class="saas_package_details_card">
                                    <div class="saas_package_header">
                                        <h3 t-esc="package.pkg_name"/>
                                        <div class="saas_package_price">
                                            <span t-if="is_free_trial" class="saas_trial_badge">Free Trial</span>
                                            <span t-else="" class="saas_price_text">
                                                <span t-esc="currency_symbol"/><span t-esc="price"/>/<span t-esc="period_text"/>
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="saas_package_description">
                                        <p t-esc="package.pkg_description"/>
                                    </div>
                                    
                                    <div class="saas_package_features" id="saasPackageFeatures">
                                        <h5>What's included:</h5>
                                        <ul>
                                            <li t-foreach="package.pkg_feature_ids" t-as="feature" t-esc="feature.pf_name"/>
                                            <li t-if="not package.pkg_feature_ids">All standard features included</li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Payment Wizard Container (Hidden initially for paid packages) -->
                                    <div class="saas_payment_wizard_wrapper" id="saasPaymentWizard" t-att-style="'display: none;' if is_free_trial else 'display: block;'">
                                        <t t-if="not is_free_trial">
                                            <t t-set="payment_providers" t-value="request.env['payment.provider'].sudo().search([('state', '=', 'enabled')])"/>
                                            <div class="saas_payment_methods_section">
                                                <h5>CHOOSE A PAYMENT METHOD</h5>
                                                
                                                <t t-if="payment_providers">
                                                    <form action="/payment/transaction" method="post" class="saas_payment_form">
                                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                        <input type="hidden" name="reference" t-att-value="'SAAS-' + str(package.id) + '-' + billing_cycle"/>
                                                        <input type="hidden" name="amount" t-att-value="price"/>
                                                        <input type="hidden" name="currency_id" t-att-value="request.env.company.currency_id.id"/>
                                                        <input type="hidden" name="partner_id" t-att-value="request.env.user.partner_id.id"/>
                                                        <input type="hidden" name="landing_route" value="/saas/payment/success"/>
                                                        <input type="hidden" name="saas_package_id" t-att-value="package.id"/>
                                                        <input type="hidden" name="saas_billing_cycle" t-att-value="billing_cycle"/>
                                                        
                                                        <!-- Payment Provider Selection -->
                                                        <div class="saas_payment_providers">
                                                            <t t-foreach="payment_providers" t-as="provider">
                                                                <div class="saas_payment_provider">
                                                                    <label class="saas_provider_option">
                                                                        <input type="radio" name="provider_id" t-att-value="provider.id" 
                                                                               t-att-checked="'checked' if provider_index == 0 else None"/>
                                                                        <div class="saas_provider_info">
                                                                            <div class="saas_provider_name">
                                                                                <span t-esc="provider.name"/>
                                                                                <t t-if="provider.code == 'demo'">
                                                                                    <small class="text-muted">(Demo - No real payment)</small>
                                                                                </t>
                                                                            </div>
                                                                            <div class="saas_provider_description" t-if="provider.pre_msg">
                                                                                <small t-esc="provider.pre_msg"/>
                                                                            </div>
                                                                        </div>
                                                                    </label>
                                                                </div>
                                                            </t>
                                                        </div>
                                                        
                                                        <!-- Pay Button -->
                                                        <div class="saas_payment_submit">
                                                            <button type="submit" class="btn btn-primary btn-lg saas_pay_button">
                                                                <i class="fa fa-credit-card" style="margin-right: 8px;"></i>
                                                                Pay <span t-esc="currency_symbol"/><span t-esc="price"/>
                                                            </button>
                                                        </div>
                                                    </form>
                                                </t>
                                                <div t-else="" class="alert alert-warning">
                                                    <h6>No Payment Methods Available</h6>
                                                    <p>Payment providers are not configured. Please contact support.</p>
                                                </div>
                                            </div>
                                        </t>
                                    </div>
                                </div>
                                
                                <!-- Legal Agreement -->
                                <div class="saas_legal_agreement">
                                    <p t-if="is_free_trial">
                                        By clicking on <strong>Start Now</strong>, you accept our 
                                        <a href="#" class="saas_legal_link">Subscription Agreement</a> and 
                                        <a href="#" class="saas_legal_link">Privacy Policy</a>
                                    </p>
                                    <p t-else="">
                                        By clicking on <strong>Start Now</strong>, you accept our 
                                        <a href="#" class="saas_legal_link">Subscription Agreement</a> and 
                                        <a href="#" class="saas_legal_link">Privacy Policy</a>. 
                                        <br/><br/>
                                        <strong>Note:</strong> A subscription will be created and an invoice will be generated for your account. You will be able to review and pay the invoice after confirmation.
                                    </p>
                                </div>
                                
                                <!-- Action Button -->
                                <div class="saas_action_section">
                                    <button type="button" class="saas_start_btn" id="saasStartBtn"
                                            t-att-data-package-id="package.id"
                                            t-att-data-billing-cycle="billing_cycle"
                                            t-att-data-is-free-trial="'true' if is_free_trial else 'false'">
                                        <span class="saas_btn_text">Start Now</span>
                                        <i class="fa fa-arrow-right saas_btn_icon"></i>
                                    </button>
                                </div>
                                
                                <!-- Loading Screen (Hidden initially) -->
                                <div class="saas_loading_screen" id="saasLoadingScreen" style="display: none;">
                                    <div class="saas_loading_content">
                                        <div class="saas_loading_spinner">
                                            <div class="saas_spinner"></div>
                                        </div>
                                        <h4 class="saas_loading_title">Setting up your instance...</h4>
                                        <p class="saas_loading_subtitle">This may take a few moments</p>
                                        <div class="saas_loading_progress">
                                            <div class="saas_progress_bar">
                                                <div class="saas_progress_fill"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Success Screen (Hidden initially) -->
                                <div class="saas_success_screen" id="saasSuccessScreen" style="display: none;">
                                    <div class="saas_success_content">
                                        <div class="saas_success_icon">
                                            <i class="fa fa-check-circle"></i>
                                        </div>
                                        <h3 class="saas_success_title">All done!</h3>
                                        <div class="saas_success_checklist">
                                            <div class="saas_check_item">
                                                <i class="fa fa-check"></i>
                                                <span>Your subscription has been created</span>
                                            </div>
                                            <div class="saas_check_item" t-if="is_free_trial">
                                                <i class="fa fa-check"></i>
                                                <span>Your instance has been deployed</span>
                                            </div>
                                            <div class="saas_check_item" t-if="not is_free_trial">
                                                <i class="fa fa-check"></i>
                                                <span>Invoice generated and ready for payment</span>
                                            </div>
                                            <div class="saas_payment_link" t-if="not is_free_trial" id="saasPaymentLink" style="display: none;">
                                                <a href="#" class="saas_invoice_link" id="saasInvoiceLink" target="_blank">
                                                    <i class="fa fa-external-link"></i>
                                                    View Invoice &amp; Make Payment
                                                </a>
                                            </div>
                                        </div>
                                        <button type="button" class="saas_continue_btn" id="saasContinueBtn">
                                            <span t-if="is_free_trial">Go to My Instance</span>
                                            <span t-else="">Continue to Dashboard</span>
                                        </button>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <template id="purchase_error" name="Purchase Error">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure oe_empty">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-6 col-md-8 text-center">
                            <div class="alert alert-danger mt-5">
                                <h4>Purchase Error</h4>
                                <p t-esc="error_message"/>
                                <a href="/web" class="btn btn-primary">Back to Home</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>