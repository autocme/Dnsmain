<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="payment_success_redirect" name="Payment Success Redirect">
        <t t-call="website.layout">
            <div id="wrap" class="oe_structure">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-8 col-md-10">

                            <!-- Success Message -->
                            <div class="text-center mt-5 mb-4">
                                <div class="saas_success_icon mb-4">
                                    <i class="fa fa-check-circle" style="font-size: 4rem; color: #28a745;"></i>
                                </div>

                                <h2 class="text-success mb-3">
                                    <t t-if="is_paid_package">ðŸŽ‰ Payment Successful!</t>
                                    <t t-else="">ðŸŽ‰ Free Trial Activated!</t>
                                </h2>
                                <h4 class="text-muted">We are creating your system and you'll be redirected after finish</h4>
                            </div>

                            <!-- Progress and Redirect Info -->
                            <div class="text-center">
                                <div class="alert alert-info">
                                    <i class="fa fa-cogs fa-spin"></i>
                                    <strong id="deploymentStatusText">Creating your system...</strong>
                                    <div class="saas_loading_dots mt-3">
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                        <div class="dot"></div>
                                    </div>
                                    <div id="deploymentError" class="mt-3" style="display: none;">
                                        <i class="fa fa-exclamation-triangle" style="color: #e74c3c;"></i>
                                        <strong style="color: #e74c3c;">System creation failed. Please contact support for assistance.</strong>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Deployment Monitoring Script -->
            <script type="text/javascript">
                <![CDATA[
                document.addEventListener('DOMContentLoaded', function() {
                    var clientId = ]]><t t-esc="client.id"/><![CDATA[;
                    var clientDomain = ']]><t t-esc="client_domain"/><![CDATA[';
                    var deploymentInitiated = ]]><t t-esc="'true' if deployment_initiated else 'false'"/><![CDATA[;

                    console.log('Payment success redirect: Starting deployment monitoring for client:', clientId);

                    // If no deployment was initiated, redirect immediately after short delay
                    if (!deploymentInitiated) {
                        console.log('No deployment needed, redirecting immediately');
                        setTimeout(function() {
                            window.location.href = clientDomain;
                        }, 3000);
                        return;
                    }

                    // Monitor deployment status
                    var checkInterval = setInterval(function() {
                        fetch('/saas/client/deployment_status/' + clientId, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                jsonrpc: '2.0',
                                method: 'call',
                                params: {}
                            })
                        })
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {
                            if (data.result) {
                                var status = data.result.status;
                                var message = data.result.message || 'Deployment in progress...';
                                
                                console.log('Deployment status:', status, 'Message:', message);
                                
                                // Update status text
                                var statusTextElement = document.getElementById('deploymentStatusText');
                                if (statusTextElement && status !== 'completed') {
                                    statusTextElement.textContent = message;
                                }
                                
                                if (status === 'completed' && data.result.deployment_complete) {
                                    // Deployment completed successfully
                                    clearInterval(checkInterval);
                                    console.log('System creation completed, redirecting to:', clientDomain);
                                    
                                    // Show success message briefly then redirect
                                    if (statusTextElement) {
                                        statusTextElement.innerHTML = '<i class="fa fa-check-circle"></i> System ready! Redirecting to your instance...';
                                    }
                                    
                                    setTimeout(function() {
                                        window.location.href = clientDomain;
                                    }, 2000);
                                    
                                } else if (status === 'failed' || status === 'cancel') {
                                    // Deployment failed or cancelled
                                    clearInterval(checkInterval);
                                    console.error('System creation failed or cancelled');
                                    
                                    // Hide loading dots and show error
                                    var loadingDots = document.querySelector('.saas_loading_dots');
                                    var errorDiv = document.getElementById('deploymentError');
                                    
                                    if (loadingDots) {
                                        loadingDots.style.display = 'none';
                                    }
                                    if (statusTextElement) {
                                        statusTextElement.style.display = 'none';
                                    }
                                    if (errorDiv) {
                                        errorDiv.style.display = 'block';
                                    }
                                }
                                // For 'deploying', 'pending' statuses, continue monitoring
                            } else {
                                console.error('Invalid response from deployment status check:', data);
                            }
                        })
                        .catch(function(error) {
                            console.error('Error checking deployment status:', error);
                            // Continue monitoring despite errors
                        });
                    }, 3000); // Check every 3 seconds
                    
                    // Safety timeout after 10 minutes
                    setTimeout(function() {
                        clearInterval(checkInterval);
                        console.log('Deployment monitoring timeout after 10 minutes, redirecting anyway');
                        window.location.href = clientDomain;
                    }, 600000);
                });
                ]]>
            </script>
        </t>
    </template>
</odoo>