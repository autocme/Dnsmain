<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ========================================================================== -->
    <!-- SAAS CLIENTS TREE VIEW -->
    <!-- ========================================================================== -->

    <record id="view_saas_client_tree" model="ir.ui.view">
        <field name="name">saas.client.tree</field>
        <field name="model">saas.client</field>
        <field name="arch" type="xml">
            <tree string="SaaS Clients"
                  decoration-muted="not sc_active"
                  decoration-success="sc_subscription_id"
                  decoration-danger="not sc_subscription_id">
                <field name="sc_sequence" string="Sequence"/>
                <field name="sc_partner_id" string="Partner"/>
                <field name="sc_package_id"/>
                <field name="sc_subscription_id"/>
                <field name="sc_template_id" string="Service Template"/>
                <field name="sc_portainer_template_id"/>
                <field name="sc_stack_id" string="Stack" optional="show"/>
                <field name="sc_active" optional="hide"/>
                <field name="sc_stack_status" string="Stack Status"
                       widget="badge"
                       decoration-success="sc_stack_status == '1'"
                       decoration-danger="sc_stack_status == '2'"
                       decoration-muted="sc_stack_status == '0'"
                       optional="hide"/>
                <field name="sc_created_date" string="Created" optional="hide"/>
                <field name="sc_last_updated" string="Last Updated" optional="hide"/>

            </tree>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- SAAS CLIENTS FORM VIEW -->
    <!-- ========================================================================== -->

    <record id="view_saas_client_form" model="ir.ui.view">
        <field name="name">saas.client.form</field>
        <field name="model">saas.client</field>
        <field name="arch" type="xml">
            <form string="SaaS Client">

                <header>
                    <button name="action_deploy" 
                            type="object" 
                            string="Deploy" 
                            class="btn-primary"
                            invisible="sc_portainer_template_id"
                            confirm="This will create a custom template and deploy the stack to Portainer. Continue?"/>
                    <field name="sc_active" widget="boolean_toggle"/>
                </header>

                <sheet>
                    
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_custom_template"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-file-code-o"
                                invisible="not sc_portainer_template_id">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Custom</span>
                                <span class="o_stat_text">Template</span>
                            </div>
                        </button>
                        
                        <button name="action_view_deployment_stack"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-stack-overflow"
                                invisible="not sc_deployment_stack_id">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Deployment</span>
                                <span class="o_stat_text">Stack</span>
                            </div>
                        </button>
                        
                        <button name="action_view_containers"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-cube"
                                invisible="not sc_deployment_stack_id">
                            <field name="sc_container_count" widget="statinfo" string="Containers"/>
                        </button>
                        
                        <button name="action_view_volumes"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-database"
                                invisible="not sc_deployment_stack_id">
                            <field name="sc_volume_count" widget="statinfo" string="Volumes"/>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="sc_sequence" readonly="1"/>
                        </h1>
                    </div>
                    <group>

                        <group>
                            <field name="sc_complete_name" invisible="1"/>
                            <field name="sc_partner_id"
                                   options="{'no_create': True}"
                                   placeholder="Select the customer partner..."/>

                            <field name="sc_package_id"
                                   options="{'no_create': True}"
                                   placeholder="Select the SaaS package..."/>
                            <field name="sc_template_id"
                                   options="{'no_create': True}"
                                   placeholder="Select subscription template..."/>
                            <field name="sc_subscription_id"
                                   options="{'no_create': True}"
                                   placeholder="Select active subscription..."/>
                            
                        </group>
                        <group>
                            <field name="sc_portainer_template_id"
                                   options="{'no_create': True}"
                                   placeholder="Select Portainer template..."/>
                            <field name="sc_stack_id"
                                   options="{'no_create': True}"
                                   placeholder="Select Portainer stack (optional)..."/>

                            <field name="sc_stack_status" readonly="1"
                                   widget="badge"
                                   decoration-success="sc_stack_status == '1'"
                                   decoration-danger="sc_stack_status == '2'"
                                   decoration-muted="sc_stack_status == '0'"/>
                        </group>
                    </group>

                    <notebook>
                        <page name="additional_notes" string="Additional Notes">
                            <field name="sc_notes"
                                   placeholder="Internal notes about this SaaS client..."/>
                        </page>

                        <page name="deployment_template" string="Deployment Template">
                            <field name="sc_docker_compose_template" widget="ace" readonly="1" placeholder="Docker Compose template inherited from package..."/>
                        </page>

                        <page name="template_variables" string="Variables">
                            <field name="sc_template_variable_ids" readonly="1">
                                <tree>
                                    <field name="tv_variable_name"/>
                                    <field name="tv_field_domain"/>
                                    <field name="tv_field_name"/>
                                </tree>
                            </field>
                        </page>

                        <page name="rendered_template" string="Rendered Template">
                            <field name="sc_rendered_template" widget="ace" readonly="1" placeholder="Final Docker Compose template with variables replaced..."/>
                        </page>

                        <page name="tracking_info" string="Other Info">
                            <group>
                                <group>
                                    <field name="create_uid"/>
                                    <field name="create_date"/>
                                </group>
                                <group>
                                    <field name="write_uid"/>
                                    <field name="write_date"/>
                                </group>
                            </group>
                        </page>
                    </notebook>

                </sheet>

                <!-- Chatter for message tracking -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>

            </form>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- SAAS CLIENTS SEARCH VIEW -->
    <!-- ========================================================================== -->


    <!-- ========================================================================== -->
    <!-- SAAS CLIENTS KANBAN VIEW -->
    <!-- ========================================================================== -->

    <record id="view_saas_client_kanban" model="ir.ui.view">
        <field name="name">saas.client.kanban</field>
        <field name="model">saas.client</field>
        <field name="arch" type="xml">
            <kanban string="SaaS Clients"
                    class="o_kanban_small_column">

                <field name="sc_partner_id"/>
                <field name="sc_template_id"/>
                <field name="sc_stack_id"/>
                <field name="sc_stack_status"/>
                <field name="sc_active"/>

                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click 
                                          #{record.sc_active.raw_value ? '' : 'o_kanban_record_archived'}">

                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="sc_partner_id"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_subtitle">
                                        <field name="sc_template_id"/>
                                    </div>
                                </div>

                                <div class="o_kanban_record_body">
                                    <t t-if="record.sc_stack_id.raw_value">
                                        <div>
                                            <i class="fa fa-cubes" title="Stack"/>
                                            <field name="sc_stack_id"/>
                                        </div>
                                    </t>
                                </div>

                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <t t-if="record.sc_stack_status.raw_value">
                                            <span t-attf-class="badge 
                                                  #{record.sc_stack_status.raw_value === '1' ? 'badge-success' : 
                                                    record.sc_stack_status.raw_value === '2' ? 'badge-danger' : 'badge-secondary'}">
                                                <t t-if="record.sc_stack_status.raw_value === '1'">Active</t>
                                                <t t-elif="record.sc_stack_status.raw_value === '2'">Inactive</t>
                                                <t t-else="">Unknown</t>
                                            </span>
                                        </t>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </t>
                </templates>

            </kanban>
        </field>
    </record>

    <!-- ========================================================================== -->
    <!-- SAAS CLIENTS ACTION -->
    <!-- ========================================================================== -->

    <record id="action_saas_client" model="ir.actions.act_window">
        <field name="name">Clients</field>
        <field name="res_model">saas.client</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first SaaS client!
            </p>
            <p>
                SaaS clients connect your customers with their subscriptions and deployed services.
                <br/>
                Link subscription templates, active subscriptions, and Portainer stacks to manage
                your SaaS offerings efficiently.
            </p>
        </field>
    </record>

</odoo>